<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stream Foot</title>

  <!-- Police similaire (grosse, condensée) -->
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1724; /* bleu nuit */
      --panel:#0b1217;
      --accent:#d92b2b; /* rouge vif */
      --muted:#9aa4ad;
    }
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#fff}
    .wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center}
    header{width:100%;background:linear-gradient(180deg,#8b0b0b,#1b1b1b);padding:10px 0;box-shadow:0 3px 10px rgba(0,0,0,0.6)}
    .container{max-width:1200px;width:100%;padding:0 16px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .logo{font-family:Anton, Impact, Arial, sans-serif;color:#fff;font-size:28px;letter-spacing:1px}
    .viewer{font-size:14px;opacity:0.9}
    main{width:100%;max-width:1200px;margin:18px auto;display:flex;gap:18px;padding:0 16px;box-sizing:border-box}
    /* chat left */
    .chat-column{width:360px;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--panel);border:2px solid var(--accent);padding:12px;border-radius:8px}
    .chat-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .messages{height:64vh;max-height:720px;overflow:auto;background:#041018;padding:8px;border-radius:6px}
    .msg{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .msg .nick{font-weight:700}
    .msg .time{font-size:12px;opacity:0.7;margin-left:6px}
    .chat-form{display:flex;gap:8px;margin-top:8px}
    .chat-form input[type=text]{flex:1;padding:8px;border-radius:6px;border:none}
    .chat-form button{background:var(--accent);border:none;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700}

    /* video column */
    .video-column{flex:1;display:flex;flex-direction:column;gap:12px}
    .video-panel{background:var(--panel);border:2px solid var(--accent);padding:12px;border-radius:8px}
    .video-box{position:relative;height:70vh;min-height:420px;border-radius:6px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
    video{width:100%;height:100%;object-fit:contain;background:#000}
    .expand-btn{position:absolute;top:12px;right:12px;background:var(--accent);border:none;padding:8px 10px;border-radius:6px;color:#fff;cursor:pointer;font-weight:700}
    .source-row{margin-top:10px;display:flex;gap:8px;align-items:center}
    .source-row input{flex:1;padding:8px;border-radius:6px;border:none}
    .note{margin-top:8px;background:var(--accent);padding:8px;border-radius:6px;text-align:center;font-weight:700}

    footer{width:100%;padding:12px 0;text-align:center;opacity:0.9;margin-top:auto;background:linear-gradient(180deg,#0000,#0000)}
    .rules{font-size:13px;opacity:0.9;margin-top:8px}
    @media (max-width:900px){
      main{flex-direction:column;padding:8px}
      .chat-column{width:100%;order:2}
      .video-column{order:1}
      .messages{max-height:260px;height:260px}
      .video-box{height:50vh}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="container">
        <div class="logo">Stream Foot</div>
        <div class="viewer">Spectateurs: <strong id="viewerCount">0</strong></div>
      </div>
    </header>

    <main>
      <!-- Chat à gauche -->
      <aside class="chat-column">
        <div class="panel">
          <div class="chat-top">
            <div style="font-weight:800">Chat</div>
            <div style="font-size:13px">Modos: <span id="modCount">0</span></div>
          </div>

          <div id="messages" class="messages" aria-live="polite"></div>

          <form id="chatForm" class="chat-form" onsubmit="return false;">
            <input id="nick" type="text" placeholder="Pseudo" value="Anonyme" maxlength="24" />
            <input id="msg" type="text" placeholder="Message..." />
            <button id="sendBtn">Envoyer</button>
          </form>

          <div class="rules">
            <div style="font-weight:700;margin-bottom:6px">Règlement</div>
            <ol style="margin:0 0 6px 18px;padding:0">
              <li>Pas d'insultes (mots censurés)</li>
              <li>10s entre chaque message</li>
              <li>Respectez les autres</li>
            </ol>
            <div style="font-size:12px;opacity:0.8">Les modérateurs peuvent supprimer des messages via Firebase (clé <code>moderators</code>).</div>
          </div>
        </div>
      </aside>

      <!-- Video à droite -->
      <section class="video-column">
        <div class="video-panel">
          <div class="video-box" id="videoBox">
            <video id="player" controls preload="metadata" src="https://www.w3schools.com/html/mov_bbb.mp4"></video>
            <button id="expandBtn" class="expand-btn">Agrandir</button>
          </div>

          <div class="source-row">
            <label style="color:var(--muted);font-size:13px">Source vidéo (remplace facilement)</label>
            <input id="sourceInput" type="text" value="https://www.w3schools.com/html/mov_bbb.mp4" />
            <button id="changeSourceBtn" class="chat-form__btn" style="background:var(--accent);border:none;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700">Changer</button>
          </div>

          <div class="note">Flux unique — agrandissez la vidéo pour la mettre en avant</div>
        </div>
      </section>
    </main>

    <footer>Stream Foot - Tout le football online</footer>
  </div>

  <!-- Firebase compat CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    /***** CONFIGURATION - remplacer par votre config Firebase *****/
    const firebaseConfig = {
      apiKey: "VOTRE_APIKEY",
      authDomain: "VOTRE_AUTHDOMAIN",
      databaseURL: "VOTRE_DATABASE_URL",
      projectId: "VOTRE_PROJECTID",
      storageBucket: "VOTRE_STORAGEBUCKET",
      messagingSenderId: "VOTRE_MESSAGING_SENDER_ID",
      appId: "VOTRE_APPID"
    };
    /***** FIN CONFIGURATION *****/

    // Init Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Utils
    const BAN_WORDS = ['putain','con','salope','nique','connard'];
    function censor(text){
      let out = text;
      BAN_WORDS.forEach(w => {
        const re = new RegExp(w,'ig');
        out = out.replace(re, m => '*'.repeat(m.length));
      });
      return out;
    }
    function sanitizeNick(s){ return (s||'').replace(/[^a-zA-Z0-9_\- ]/g,'').trim().slice(0,24) || 'Anonyme'; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c];}); }

    // DOM
    const messagesEl = document.getElementById('messages');
    const sendBtn = document.getElementById('sendBtn');
    const msgInput = document.getElementById('msg');
    const nickInput = document.getElementById('nick');
    const viewerCountEl = document.getElementById('viewerCount');
    const modCountEl = document.getElementById('modCount');
    const player = document.getElementById('player');
    const sourceInput = document.getElementById('sourceInput');
    const changeSourceBtn = document.getElementById('changeSourceBtn');
    const expandBtn = document.getElementById('expandBtn');
    const videoBox = document.getElementById('videoBox');

    // presence id
    const uid = 'u_' + Math.random().toString(36).slice(2,9);

    // presence set
    const presenceRef = db.ref('presence/' + uid);
    presenceRef.set({nick: sanitizeNick(nickInput.value), ts: Date.now()});
    presenceRef.onDisconnect().remove();

    // update viewer count
    const presRoot = db.ref('presence');
    presRoot.on('value', snap => {
      const v = snap.val() || {};
      viewerCountEl.textContent = Object.keys(v).length;
    });

    // messages listener (last 500)
    const msgsRef = db.ref('messages');
    msgsRef.limitToLast(500).on('value', snap => {
      const v = snap.val() || {};
      messagesEl.innerHTML = '';
      Object.keys(v).sort((a,b) => (v[a].ts||0)-(v[b].ts||0)).forEach(key => {
        const m = v[key];
        const div = document.createElement('div');
        div.className = 'msg';
        const nickHtml = '<span class="nick">'+escapeHtml(m.nick||'Anonyme')+'</span><span class="time"> · '+new Date(m.ts||0).toLocaleTimeString()+'</span>';
        div.innerHTML = nickHtml + '<div class="text">'+escapeHtml(m.text||'')+'</div>';
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    // moderators count
    const modsRef = db.ref('moderators');
    modsRef.on('value', snap => {
      const v = snap.val() || {};
      modCountEl.textContent = Object.keys(v).length;
    });

    // 10s cooldown client side
    let lastMsgTs = Number(localStorage.getItem('sf_last_msg')||0);

    sendBtn.addEventListener('click', async () => {
      const now = Date.now();
      if (now - lastMsgTs < 10000) {
        alert('Veuillez attendre 10 secondes entre chaque message.');
        return;
      }
      const nick = sanitizeNick(nickInput.value);
      const text = (msgInput.value||'').trim();
      if (!text) return;
      const cens = censor(text);
      await db.ref('messages').push({nick, text: cens, ts: Date.now()});
      lastMsgTs = Date.now();
      localStorage.setItem('sf_last_msg', String(lastMsgTs));
      msgInput.value = '';
    });

    // allow pressing Enter in message input
    msgInput.addEventListener('keydown', (e) => { if (e.key==='Enter') sendBtn.click(); });

    // change video source easily, update player without reload
    changeSourceBtn.addEventListener('click', () => {
      const src = (sourceInput.value||'').trim();
      if (!src) return alert('Entrez une source valide');
      // set new src and try to load
      player.pause();
      player.src = src;
      player.load();
      // try play (some browsers block autoplay)
      player.play().catch(()=>{});
    });

    // expand toggle (fullscreen)
    expandBtn.addEventListener('click', async () => {
      if (!document.fullscreenElement) {
        if (videoBox.requestFullscreen) await videoBox.requestFullscreen();
        else if (videoBox.webkitRequestFullscreen) await videoBox.webkitRequestFullscreen();
        expandBtn.textContent = 'Réduire';
      } else {
        if (document.exitFullscreen) await document.exitFullscreen();
        expandBtn.textContent = 'Agrandir';
      }
    });

    // update presence nick on change
    nickInput.addEventListener('change', () => {
      presenceRef.set({nick: sanitizeNick(nickInput.value), ts: Date.now()});
    });

    // helper: allow moderators to delete messages by adding a key in DB: moderators/<modId> = true
    // This UI does not include mod delete buttons to keep it simple; to delete, use Firebase console.
  </script>
</body>
</html>
