<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stream Foot (proxy)</title>
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
  <style>
    /* conserve ton CSS existant — abrégé ici pour la clarté */
    body{background:#0f1724;color:#fff;font-family:Inter,Arial}
    .video-box{height:60vh;background:#000;display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <h1>Stream Foot</h1>
  <div class="video-box" id="videoBox">
    <video id="player" controls preload="metadata"></video>
  </div>

  <script>
    async function obtainSignedUrl(streamId = 'main') {
      try {
        const resp = await fetch(`/token?id=${encodeURIComponent(streamId)}`, { credentials: 'include' });
        if (!resp.ok) throw new Error('token request failed: ' + resp.status);
        const data = await resp.json();
        return data.url; // ex: /stream/main?token=...&exp=...
      } catch (e) {
        console.error('Erreur token', e);
        return null;
      }
    }

    (async () => {
      const player = document.getElementById('player');
      const signed = await obtainSignedUrl('main');
      if (!signed) {
        player.innerHTML = '<p>Impossible d\'obtenir le flux</p>';
        return;
      }
      // assigner l'URL signée — le client ne voit pas la vraie origine
      player.src = signed;
      // essaye de jouer
      player.load();
      player.play().catch(()=>{});
      // option : renouveler le token avant expiration (si TTL court)
      // ici token TTL=60s ; si le lecteur est long on devrait re-obtenir un token et re-lancer le flux proprement
    })();
  </script>
</body>
</html>

